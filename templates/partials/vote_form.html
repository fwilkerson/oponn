<section id="vote-section">
    {% set status, label = get_ballot_status(ballot) %}
    {% set is_active = (status == 'active') %}
    <h2>vote_on: {{ ballot.measure }}</h2>
    {% if has_voted %}
        <div class="alert-info">
            <span>[*] you_have_already_voted_on_this_ballot.</span>
        </div>
        <div style="margin-top: 1rem;">
            <a href="/results/{{ ballot.ballot_id }}"
               class="button button-secondary">view_current_results</a>
        </div>
    {% else %}
        <form hx-post="/vote/{{ ballot.ballot_id }}"
              hx-target="#vote-section"
              hx-swap="outerHTML">
            <input type="hidden" name="X-CSRF-Token" value="{{ csrf_token }}" />
            {% if error %}<div class="alert-error">{{ error }}</div>{% endif %}
            <div class="radio-group">
                {% for option in ballot.options %}
                    <div class="radio-item">
                        <label class="radio-label {% if field_errors and field_errors.option %}invalid{% endif %}">
                            <input type="radio" name="option" value="{{ option }}" required />
                            <span style="font-size: 0.9rem;">{{ option }}</span>
                        </label>
                        {% if field_errors and field_errors.option %}<div class="field-error-msg">{{ field_errors.option }}</div>{% endif %}
                    </div>
                {% endfor %}
                {% if ballot.allow_write_in %}
                    <div class="radio-item">
                        <label class="radio-label {% if field_errors and (field_errors.option or field_errors.write_in_value) %}invalid{% endif %}">
                            <input type="radio" name="option" value="__write_in__" id="write-in-radio" />
                            <span style="display: flex;
                                         gap: 0.5rem;
                                         width: 100%;
                                         font-size: 0.9rem;
                                         align-items: baseline">
                                write_in:
                                <input type="text"
                                       name="write_in_value"
                                       placeholder="..."
                                       class="{% if field_errors and field_errors.write_in_value %}invalid{% endif %}"
                                       style="background: none;
                                              border: none;
                                              border-bottom: 1px solid var(--border-color);
                                              color: inherit;
                                              padding: 0;
                                              border-radius: 0;
                                              font-family: inherit;
                                              width: 100%;
                                              font-size: 0.9rem"
                                       onfocus="document.getElementById('write-in-radio').checked = true" />
                            </span>
                        </label>
                        {% if field_errors and field_errors.option %}<div class="field-error-msg">{{ field_errors.option }}</div>{% endif %}
                        {% if field_errors and field_errors.write_in_value %}
                            <div class="field-error-msg">{{ field_errors.write_in_value }}</div>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
            <div style="display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-top: 3rem">
                <button type="submit"
                        class="button-action"
                        {% if not is_active %}disabled{% endif %}>
                    cast_vote <span class="htmx-indicator">...</span>
                </button>
                <div class="status-indicator status-{{ status }}">
                    <span class="status-dot"></span>
                    {{ label | lower }}
                </div>
            </div>
        </form>
        <div style="margin-top: 2rem;">
            <a href="/results/{{ ballot.ballot_id }}" class="link-quiet">view_live_results</a>
        </div>
    {% endif %}
</section>
